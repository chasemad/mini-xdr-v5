FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies for the agent
RUN pip install --no-cache-dir \
    aiohttp==3.9.5 \
    aiofiles==23.2.1 \
    cryptography==42.0.8

# Copy the ingestion agent
COPY backend/app/agents/ingestion_agent.py .

# Create non-root user
RUN useradd --create-home --shell /bin/bash agent && chown -R agent:agent /app
USER agent

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s --retries=3 \
    CMD pgrep -f ingestion_agent.py || exit 1

# Default configuration (override with environment variables)
ENV BACKEND_URL="http://mini-xdr-backend:8000"
ENV SOURCE_TYPE="cowrie"
ENV HOSTNAME="agent"
ENV BATCH_SIZE="50"
ENV FLUSH_INTERVAL="30"

# Start command
CMD ["python", "ingestion_agent.py", "--config", "/tmp/agent-config.json"]

# Create default config on startup
RUN echo '{"backend_url": "$BACKEND_URL", "source_type": "$SOURCE_TYPE", "hostname": "$HOSTNAME", "api_key": "$API_KEY", "log_paths": {"cowrie": "/var/log/cowrie/cowrie.json", "suricata": "/var/log/suricata/eve.json"}, "batch_size": 50, "flush_interval": 30}' > /tmp/agent-config.json
