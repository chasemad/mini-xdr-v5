# ============================================================================
# Mini-XDR Persistent Volumes - Production (AWS EBS)
# ============================================================================
# Optimized for AWS EKS with cost-effective storage
# - Uses EBS gp3 volumes (better performance than gp2 at same cost)
# - Minimal storage footprint
# - Backup-ready with snapshots
# ============================================================================

---
# ============================================================================
# Storage Class - AWS EBS gp3 with encryption
# ============================================================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: mini-xdr-gp3
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  encrypted: "true"
  # gp3 baseline: 3000 IOPS, 125 MB/s throughput (included in price)
  iops: "3000"
  throughput: "125"
  fsType: ext4
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Retain  # Keep data even if PVC is deleted

---
# ============================================================================
# Data PVC - Application runtime data
# ============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mini-xdr-data-pvc
  namespace: mini-xdr
  labels:
    app: mini-xdr
    component: backend
  annotations:
    volume.beta.kubernetes.io/storage-class: "mini-xdr-gp3"
spec:
  accessModes:
    - ReadWriteOnce  # Single node access (EBS limitation)
  storageClassName: mini-xdr-gp3
  resources:
    requests:
      storage: 10Gi  # 10GB for logs, evidence, runtime data

---
# ============================================================================
# Models PVC - ML model storage (shared across backend pods)
# ============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mini-xdr-models-pvc
  namespace: mini-xdr
  labels:
    app: mini-xdr
    component: backend
  annotations:
    volume.beta.kubernetes.io/storage-class: "efs-sc"  # Use EFS for multi-pod access
spec:
  accessModes:
    - ReadWriteMany  # Multiple pods can read models
  storageClassName: efs-sc
  resources:
    requests:
      storage: 5Gi  # 5GB for ML models (isolation forest, LSTM, specialists)

---
# ============================================================================
# EFS Storage Class - For shared model access across pods
# ============================================================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc
provisioner: efs.csi.aws.com
parameters:
  provisioningMode: efs-ap
  fileSystemId: ${EFS_FILE_SYSTEM_ID}  # Created by infrastructure script
  directoryPerms: "755"
  gidRangeStart: "1000"
  gidRangeEnd: "2000"
  basePath: "/mini-xdr"
volumeBindingMode: Immediate
allowVolumeExpansion: true
reclaimPolicy: Retain

---
# ============================================================================
# VolumeSnapshotClass - For backups
# ============================================================================
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: mini-xdr-snapshot-class
driver: ebs.csi.aws.com
deletionPolicy: Retain
parameters:
  tagSpecification_1: "Project=mini-xdr"
  tagSpecification_2: "Environment=production"

---
# ============================================================================
# Notes on Storage Costs (us-east-1):
# - EBS gp3: $0.08/GB/month ($0.80/month for 10GB)
# - EFS: $0.30/GB/month ($1.50/month for 5GB)
# - Total: ~$2.30/month for storage
#
# Performance:
# - gp3: 3000 IOPS baseline, 125 MB/s throughput
# - EFS: Scalable IOPS, lower latency for multi-pod access
#
# Backup Strategy:
# - Daily snapshots via VolumeSnapshot
# - Retention: 7 days
# - Cost: ~$0.05/GB/month for snapshots
# ============================================================================
