AWSTemplateFormatVersion: '2010-09-09'
Description: 'Mini-XDR Honeypot Infrastructure - Multi-region deployment'

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 Key Pair for SSH access
    
  YourPublicIP:
    Type: String
    Description: Your public IP address (get from: curl -4 icanhazip.com)
    AllowedPattern: '^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$'
    
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues: [t3.micro, t3.small, t3.medium]
    Description: EC2 instance type (t3.micro is free tier eligible)
    
  DeploymentRegions:
    Type: CommaDelimitedList
    Default: "us-east-1,eu-west-1,ap-southeast-1"
    Description: Regions to deploy honeypots

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0e001c9271cf7f3b9  # Ubuntu 22.04 LTS
    us-west-2:
      AMI: ami-017fecd1353bcc96e  # Ubuntu 22.04 LTS  
    eu-west-1:
      AMI: ami-0905a3c97561e0b69  # Ubuntu 22.04 LTS
    ap-southeast-1:
      AMI: ami-0df7a207adb9748c7  # Ubuntu 22.04 LTS

Resources:
  # Security Group for Honeypots
  HoneypotSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Mini-XDR honeypots
      GroupName: mini-xdr-honeypot-sg
      SecurityGroupIngress:
        # SSH Honeypot (fake SSH on port 22)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH Honeypot
        # Web Honeypots
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP Honeypot
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS Honeypot
        # Management SSH (restricted to your IP)
        - IpProtocol: tcp
          FromPort: 22022
          ToPort: 22022
          CidrIp: !Sub "${YourPublicIP}/32"
          Description: SSH Management
        # Additional honeypot services
        - IpProtocol: tcp
          FromPort: 21
          ToPort: 21
          CidrIp: 0.0.0.0/0
          Description: FTP Honeypot
        - IpProtocol: tcp
          FromPort: 23
          ToPort: 23
          CidrIp: 0.0.0.0/0
          Description: Telnet Honeypot
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
          Description: MySQL Honeypot
      Tags:
        - Key: Name
          Value: mini-xdr-honeypot-sg
        - Key: Project
          Value: mini-xdr

  # IAM Role for honeypot instances (CloudWatch access)
  HoneypotRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Tags:
        - Key: Project
          Value: mini-xdr

  HoneypotInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref HoneypotRole

  # Primary Honeypot Instance
  PrimaryHoneypot:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref HoneypotSecurityGroup
      IamInstanceProfile: !Ref HoneypotInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          
          # Update system
          apt-get update -y
          apt-get upgrade -y
          
          # Install dependencies
          apt-get install -y python3 python3-venv python3-pip git curl wget htop vim ufw
          
          # Configure firewall
          ufw --force enable
          ufw allow 22022/tcp
          ufw allow 22/tcp
          ufw allow 80/tcp
          ufw allow 443/tcp
          ufw allow 21/tcp
          ufw allow 23/tcp
          ufw allow 3306/tcp
          
          # Move SSH to alternate port
          sed -i 's/#Port 22/Port 22022/' /etc/ssh/sshd_config
          sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
          systemctl restart sshd
          
          # Create XDR user
          useradd -m -s /bin/bash xdrops
          usermod -aG sudo xdrops
          mkdir -p /home/xdrops/.ssh
          chmod 700 /home/xdrops/.ssh
          chown -R xdrops:xdrops /home/xdrops/.ssh
          
          # Install Cowrie honeypot
          cd /opt
          git clone https://github.com/cowrie/cowrie.git
          cd cowrie
          python3 -m venv cowrie-env
          source cowrie-env/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Configure Cowrie
          cp etc/cowrie.cfg.dist etc/cowrie.cfg
          cat >> etc/cowrie.cfg << 'COWRIEEOF'
          
          [output_jsonlog]
          enabled = true
          logfile = var/log/cowrie/cowrie.json
          epoch_timestamp = false
          
          [honeypot]
          hostname = aws-honeypot-${AWS::Region}
          COWRIEEOF
          
          # Create cowrie user and service
          useradd -r -s /bin/false cowrie
          chown -R cowrie:cowrie /opt/cowrie
          
          # Service file
          cat > /etc/systemd/system/cowrie.service << 'SERVICEEOF'
          [Unit]
          Description=Cowrie SSH/Telnet Honeypot
          After=network.target
          
          [Service]
          Type=forking
          User=cowrie
          Group=cowrie
          ExecStart=/opt/cowrie/cowrie-env/bin/python /opt/cowrie/bin/cowrie start
          ExecStop=/opt/cowrie/cowrie-env/bin/python /opt/cowrie/bin/cowrie stop
          PIDFile=/opt/cowrie/var/run/cowrie.pid
          WorkingDirectory=/opt/cowrie
          PrivateTmp=yes
          
          [Install]
          WantedBy=multi-user.target
          SERVICEEOF
          
          # Port forwarding
          iptables -t nat -A PREROUTING -p tcp --dport 22 -j REDIRECT --to-port 2222
          apt-get install -y iptables-persistent
          iptables-save > /etc/iptables/rules.v4
          
          # Start Cowrie
          systemctl daemon-reload
          systemctl enable cowrie
          systemctl start cowrie
          
          # Install Fluent Bit
          curl https://raw.githubusercontent.com/fluent/fluent-bit/master/install.sh | sh
          
          # Configure log forwarding
          cat > /etc/fluent-bit/fluent-bit.conf << 'FLUENTEOF'
          [SERVICE]
              Flush         1
              Log_Level     info
              Daemon        off
          
          [INPUT]
              Name              tail
              Path              /opt/cowrie/var/log/cowrie/cowrie.json
              Parser            json
              Tag               cowrie
              Refresh_Interval  5
              Read_from_Head    false
          
          [OUTPUT]
              Name  http
              Match cowrie
              Host  ${YourPublicIP}
              Port  8000
              URI   /ingest/multi
              Format json
              Header Authorization Bearer aws-honeypot-key
              Retry_Limit 5
          FLUENTEOF
          
          systemctl enable fluent-bit
          systemctl start fluent-bit
          
          # Install CloudWatch agent
          wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
          dpkg -i amazon-cloudwatch-agent.deb
          
          echo "Honeypot setup complete!" > /var/log/honeypot-setup.log
          
      Tags:
        - Key: Name
          Value: !Sub "mini-xdr-honeypot-${AWS::Region}"
        - Key: Project
          Value: mini-xdr
        - Key: Type
          Value: honeypot

  # Elastic IP for consistent addressing
  HoneypotEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref PrimaryHoneypot
      Tags:
        - Key: Name
          Value: !Sub "mini-xdr-honeypot-eip-${AWS::Region}"
        - Key: Project
          Value: mini-xdr

  # CloudWatch Log Group for monitoring
  HoneypotLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ec2/mini-xdr-honeypot-${AWS::Region}"
      RetentionInDays: 7

Outputs:
  HoneypotPublicIP:
    Description: Public IP of the honeypot
    Value: !Ref HoneypotEIP
    Export:
      Name: !Sub "${AWS::StackName}-PublicIP"
      
  HoneypotInstanceId:
    Description: Instance ID of the honeypot
    Value: !Ref PrimaryHoneypot
    Export:
      Name: !Sub "${AWS::StackName}-InstanceId"
      
  SSHCommand:
    Description: SSH command to connect to honeypot for management
    Value: !Sub "ssh -i ~/.ssh/${KeyPairName}.pem -p 22022 ubuntu@${HoneypotEIP}"
    
  SecurityGroupId:
    Description: Security Group ID for honeypots
    Value: !Ref HoneypotSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-SecurityGroup"

