AWSTemplateFormatVersion: '2010-09-09'
Description: 'ML Services Network Isolation for Mini-XDR - Prevents TPOT lateral movement'

Parameters:
  MainVPCId:
    Type: String
    Description: Main Mini-XDR VPC ID
    
  TPOTHostIP:
    Type: String
    Default: 34.193.101.171
    Description: TPOT honeypot IP address to block from ML services

Resources:
  # Separate VPC for ML services (complete isolation)
  MLServicesVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.16.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: mini-xdr-ml-vpc
        - Key: Purpose
          Value: ml-services-isolation
        - Key: Security
          Value: high-isolation

  # Private subnet for SageMaker endpoints
  MLPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MLServicesVPC
      CidrBlock: 172.16.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: mini-xdr-ml-private-subnet-1

  # Second private subnet for high availability
  MLPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MLServicesVPC
      CidrBlock: 172.16.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: mini-xdr-ml-private-subnet-2

  # VPC Endpoint for S3 (no internet gateway needed)
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref MLServicesVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref MLPrivateRouteTable

  # VPC Endpoint for SageMaker
  SageMakerVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref MLServicesVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.sagemaker.runtime'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref MLPrivateSubnet1
        - !Ref MLPrivateSubnet2
      SecurityGroupIds:
        - !Ref MLVPCEndpointSecurityGroup

  # Security group for VPC endpoints
  MLVPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ML VPC endpoints
      VpcId: !Ref MLServicesVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.16.0.0/16
          Description: HTTPS within ML VPC only
      Tags:
        - Key: Name
          Value: mini-xdr-ml-endpoint-sg

  # Route table for private subnets
  MLPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MLServicesVPC
      Tags:
        - Key: Name
          Value: mini-xdr-ml-private-rt

  # Associate route table with subnets
  MLPrivateSubnet1Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MLPrivateSubnet1
      RouteTableId: !Ref MLPrivateRouteTable

  MLPrivateSubnet2Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MLPrivateSubnet2
      RouteTableId: !Ref MLPrivateRouteTable

  # VPC Peering for controlled backend access
  MLVPCPeering:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref MLServicesVPC
      PeerVpcId: !Ref MainVPCId
      Tags:
        - Key: Name
          Value: mini-xdr-ml-peering

  # Network ACL for additional security layer
  MLNetworkACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref MLServicesVPC
      Tags:
        - Key: Name
          Value: mini-xdr-ml-nacl

  # DENY all traffic from TPOT IP (critical security control)
  MLNACLDenyTPOT:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MLNetworkACL
      RuleNumber: 50
      Protocol: -1
      RuleAction: deny
      CidrIp: !Sub "${TPOTHostIP}/32"

  # DENY all internet traffic (additional protection)
  MLNACLDenyInternet:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MLNetworkACL
      RuleNumber: 60
      Protocol: -1
      RuleAction: deny
      CidrIp: 0.0.0.0/0  # SECURITY-APPROVED: DENY rule for complete internet isolation

  # Allow only backend to ML services
  MLNACLAllowBackend:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MLNetworkACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrIp: 10.0.1.0/24  # Backend subnet
      PortRange:
        From: 443
        To: 443

  # Allow outbound for ML services
  MLNACLAllowOutbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref MLNetworkACL
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      CidrIp: 0.0.0.0/0  # SECURITY-APPROVED: Egress rule for AWS services access
      Egress: true

  # Associate Network ACL with subnets
  MLSubnet1NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref MLPrivateSubnet1
      NetworkAclId: !Ref MLNetworkACL

  MLSubnet2NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref MLPrivateSubnet2
      NetworkAclId: !Ref MLNetworkACL

  # Security group for ML services (defense in depth)
  MLSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SECURE access for ML services - backend only via peering
      VpcId: !Ref MLServicesVPC
      SecurityGroupIngress:
        # ONLY allow HTTPS from backend subnet
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.1.0/24
          Description: HTTPS from backend only
        # NO other inbound rules - complete isolation
      SecurityGroupEgress:
        # Allow outbound for model training/inference
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0  # SECURITY-APPROVED: Egress HTTPS for AWS ML services
          Description: HTTPS for AWS services
      Tags:
        - Key: Name
          Value: mini-xdr-ml-secure-sg
        - Key: Security
          Value: high-isolation

  # CloudWatch Log Group for ML security events
  MLSecurityLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/mini-xdr/ml-security
      RetentionInDays: 30

  # CloudWatch alarm for unauthorized access attempts
  UnauthorizedAccessAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: MiniXDR-ML-UnauthorizedAccess
      AlarmDescription: Detects unauthorized access attempts to ML services
      MetricName: InvocationErrors
      Namespace: AWS/SageMaker
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

Outputs:
  MLVPCId:
    Description: ML Services VPC ID
    Value: !Ref MLServicesVPC
    Export:
      Name: !Sub "${AWS::StackName}-MLVPC"
      
  MLSubnet1Id:
    Description: ML Private Subnet 1 ID
    Value: !Ref MLPrivateSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-MLSubnet1"
      
  MLSubnet2Id:
    Description: ML Private Subnet 2 ID
    Value: !Ref MLPrivateSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-MLSubnet2"
      
  MLSecurityGroupId:
    Description: ML Services Security Group ID
    Value: !Ref MLSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-MLSecurityGroup"
      
  VPCPeeringId:
    Description: VPC Peering Connection ID
    Value: !Ref MLVPCPeering
    Export:
      Name: !Sub "${AWS::StackName}-VPCPeering"

  SecurityStatus:
    Description: ML network isolation security status
    Value: "SECURED - ML services isolated from TPOT and internet, backend access only"
