"""Lightweight malware analysis pipeline for downloaded files."""
from __future__ import annotations

import asyncio
import hashlib
import logging
import os
import re
from dataclasses import dataclass
from typing import Dict, Optional

from .models import Event

logger = logging.getLogger(__name__)


@dataclass
class MalwareAnalysisResult:
    file_path: Optional[str]
    sha256: Optional[str]
    size_bytes: Optional[int]
    suspicious_matches: Dict[str, int]
    is_suspicious: bool


class MalwareAnalyzer:
    """Performs basic static analysis on downloaded files."""

    suspicious_patterns = {
        "powershell_download": re.compile(r"powershell\s+-[^\"]* download", re.IGNORECASE),
        "reverse_shell": re.compile(r"nc\s+-", re.IGNORECASE),
        "user_creation": re.compile(r"useradd|net user", re.IGNORECASE),
        "crypto_miner": re.compile(r"xmrig|minerd|cpuminer", re.IGNORECASE),
        "persistence": re.compile(r"cron|schtasks|rc\.local", re.IGNORECASE),
    }

    binary_markers = [b"MZ", b"\x7fELF", b"#!/bin/bash", b"#!/usr/bin"]

    async def analyze_event(self, event: Event) -> Optional[MalwareAnalysisResult]:
        if not event or event.eventid != "cowrie.session.file_download":
            return None

        raw = event.raw if isinstance(event.raw, dict) else {}
        file_path = raw.get("local_path") or raw.get("filepath") or raw.get("destfile")

        if not file_path or not os.path.exists(file_path):
            logger.debug("MalwareAnalyzer: file path missing or not accessible for event %s", event.id)
            return None

        # Run blocking file operations in executor to avoid blocking the loop
        loop = asyncio.get_running_loop()
        sha256 = await loop.run_in_executor(None, self._hash_file, file_path)
        size_bytes = os.path.getsize(file_path)
        suspicious_matches = await loop.run_in_executor(None, self._scan_file, file_path)

        is_suspicious = any(count > 0 for count in suspicious_matches.values())

        analysis = MalwareAnalysisResult(
            file_path=file_path,
            sha256=sha256,
            size_bytes=size_bytes,
            suspicious_matches=suspicious_matches,
            is_suspicious=is_suspicious,
        )

        # Persist results back onto the raw payload for later triage/use
        raw["malware_analysis"] = {
            "sha256": sha256,
            "size_bytes": size_bytes,
            "suspicious_markers": suspicious_matches,
            "is_suspicious": is_suspicious,
        }
        event.raw = raw

        if is_suspicious:
            logger.warning("MalwareAnalyzer: suspicious download detected (%s)", file_path)
        else:
            logger.info("MalwareAnalyzer: analyzed download %s", file_path)

        return analysis

    def _hash_file(self, file_path: str) -> str:
        sha256 = hashlib.sha256()
        with open(file_path, "rb") as handle:
            for chunk in iter(lambda: handle.read(65536), b""):
                sha256.update(chunk)
        return sha256.hexdigest()

    def _scan_file(self, file_path: str) -> Dict[str, int]:
        """Return count of suspicious pattern matches within the file."""
        matches: Dict[str, int] = {key: 0 for key in self.suspicious_patterns}
        matches["binary_signature"] = 0

        try:
            with open(file_path, "rb") as handle:
                data = handle.read()

            # Binary markers
            for marker in self.binary_markers:
                if marker in data:
                    matches["binary_signature"] += 1

            text_data = data.decode("utf-8", errors="ignore")
            for key, pattern in self.suspicious_patterns.items():
                results = pattern.findall(text_data)
                matches[key] += len(results)

        except Exception as exc:
            logger.error("MalwareAnalyzer: failed to scan %s (%s)", file_path, exc)

        return matches


# Global instance
malware_analyzer = MalwareAnalyzer()

