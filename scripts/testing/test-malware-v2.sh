#!/bin/bash
# Test Malware Detection V2 - Different IP with critical indicators

set -e

XDR_API="http://localhost:8000"
ATTACKER_IP="192.168.100.99"  # New test IP

echo "ğŸ§ª Testing Enhanced Malware Priority Detection V2"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Using IP: $ATTACKER_IP"
echo ""

# Send multiple events with critical indicators
echo "ğŸš¨ Sending malware attack chain..."

for i in {1..5}; do
  timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)
  
  curl -s -X POST "$XDR_API/ingest/multi" \
    -H "Content-Type: application/json" \
    -d "{
      \"source_type\": \"honeypot\",
      \"hostname\": \"victim-host\",
      \"events\": [
        {
          \"eventid\": \"malware.detected\",
          \"timestamp\": \"$timestamp\",
          \"src_ip\": \"$ATTACKER_IP\",
          \"dst_port\": 80,
          \"message\": \"Malware download: trojan ransomware detected with data_exfiltration capabilities\",
          \"raw\": {
            \"attack_indicators\": [\"malware\", \"ransomware\", \"data_exfiltration\", \"privilege_escalation\"]
          }
        }
      ]
    }" > /dev/null
  
  echo "  âœ“ Event $i/5 sent"
  sleep 1
done

echo ""
echo "â³ Waiting for detection engine to process..."
sleep 5

# Check if incident was created
incident_id=$(sqlite3 backend/xdr.db "SELECT id FROM incidents WHERE src_ip = '$ATTACKER_IP' ORDER BY id DESC LIMIT 1;")

if [ -n "$incident_id" ]; then
  echo ""
  echo "âœ… Incident Created! ID: $incident_id"
  echo ""
  echo "ğŸ“Š Incident Details:"
  sqlite3 -header backend/xdr.db "SELECT id, src_ip, escalation_level, risk_score, reason FROM incidents WHERE id = $incident_id;"
  echo ""
  echo "ğŸ¯ Check it out at: http://localhost:3000/incidents/incident/$incident_id"
  echo ""
  echo "Expected: escalation_level = HIGH (not low!)"
else
  echo "âŒ No incident created yet. Check backend logs."
fi

