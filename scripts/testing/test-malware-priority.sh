#!/bin/bash
# Test Malware Detection Priority Enhancement
# Sends simulated malware/data exfiltration events to test priority escalation

set -e

XDR_API="http://localhost:8000"
ATTACKER_IP="203.0.113.52"  # Test IP

echo "ğŸ§ª Testing Enhanced Malware Priority Detection"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if backend is running
if ! curl -s "$XDR_API/health" > /dev/null 2>&1; then
    echo "âŒ Mini-XDR backend is not running at $XDR_API"
    echo "Please start it with: cd backend && source venv/bin/activate && uvicorn app.main:app"
    exit 1
fi

echo "âœ… Mini-XDR backend is running"
echo ""

# Phase 1: Send malware download events
echo "ğŸ“¦ Phase 1: Simulating Malware Download..."
timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)

curl -s -X POST "$XDR_API/ingest/multi" \
  -H "Content-Type: application/json" \
  -d "{
    \"source_type\": \"simulated_attack\",
    \"hostname\": \"test-victim\",
    \"events\": [
      {
        \"eventid\": \"malware.download\",
        \"timestamp\": \"$timestamp\",
        \"src_ip\": \"$ATTACKER_IP\",
        \"dst_port\": 80,
        \"message\": \"Malicious payload downloaded: trojan.exe\",
        \"raw\": {
          \"attack_type\": \"malware_download\",
          \"filename\": \"trojan.exe\",
          \"file_hash\": \"a1b2c3d4e5f6g7h8i9j0\",
          \"file_size\": \"2.5MB\",
          \"indicators\": [\"malware\", \"trojan\", \"backdoor\"],
          \"malware_family\": \"Emotet\"
        }
      }
    ]
  }" > /dev/null

echo "  âœ“ Malware download event sent"
sleep 2

# Phase 2: Send privilege escalation events
echo "â¬†ï¸  Phase 2: Simulating Privilege Escalation..."
timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)

curl -s -X POST "$XDR_API/ingest/multi" \
  -H "Content-Type: application/json" \
  -d "{
    \"source_type\": \"simulated_attack\",
    \"hostname\": \"test-victim\",
    \"events\": [
      {
        \"eventid\": \"privilege.escalation\",
        \"timestamp\": \"$timestamp\",
        \"src_ip\": \"$ATTACKER_IP\",
        \"dst_port\": 22,
        \"message\": \"Privilege escalation attempt detected\",
        \"raw\": {
          \"attack_type\": \"privilege_escalation\",
          \"command\": \"sudo -l; whoami; id\",
          \"indicators\": [\"privilege_escalation\", \"root_access\"],
          \"success\": true
        }
      }
    ]
  }" > /dev/null

echo "  âœ“ Privilege escalation event sent"
sleep 2

# Phase 3: Send data exfiltration events
echo "ğŸ“¤ Phase 3: Simulating Data Exfiltration..."
timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)

curl -s -X POST "$XDR_API/ingest/multi" \
  -H "Content-Type: application/json" \
  -d "{
    \"source_type\": \"simulated_attack\",
    \"hostname\": \"test-victim\",
    \"events\": [
      {
        \"eventid\": \"data.exfiltration\",
        \"timestamp\": \"$timestamp\",
        \"src_ip\": \"$ATTACKER_IP\",
        \"dst_port\": 443,
        \"message\": \"Large data transfer detected\",
        \"raw\": {
          \"attack_type\": \"data_exfiltration\",
          \"data_size\": \"15MB\",
          \"destination\": \"evil.attacker.com\",
          \"indicators\": [\"data_exfiltration\", \"sensitive_data\"],
          \"files_accessed\": [\"customer_database.sql\", \"passwords.txt\"]
        }
      }
    ]
  }" > /dev/null

echo "  âœ“ Data exfiltration event sent"
sleep 2

# Phase 4: Send persistence mechanism events
echo "ğŸ”’ Phase 4: Simulating Persistence Mechanism..."
timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000000Z)

curl -s -X POST "$XDR_API/ingest/multi" \
  -H "Content-Type: application/json" \
  -d "{
    \"source_type\": \"simulated_attack\",
    \"hostname\": \"test-victim\",
    \"events\": [
      {
        \"eventid\": \"persistence.backdoor\",
        \"timestamp\": \"$timestamp\",
        \"src_ip\": \"$ATTACKER_IP\",
        \"dst_port\": 22,
        \"message\": \"Backdoor installation detected\",
        \"raw\": {
          \"attack_type\": \"persistence\",
          \"mechanism\": \"cron_job\",
          \"indicators\": [\"backdoor\", \"persistence\", \"rootkit\"],
          \"files_created\": [\"/tmp/.hidden_shell\", \"/etc/cron.d/backdoor\"]
        }
      }
    ]
  }" > /dev/null

echo "  âœ“ Persistence mechanism event sent"
sleep 3

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Attack Simulation Complete!"
echo ""
echo "ğŸ“Š Expected Results:"
echo "  â€¢ Priority Level: HIGH or CRITICAL (not Low!)"
echo "  â€¢ ML Confidence: 68%+ (boosted from base)"
echo "  â€¢ Risk Score: 75%+"
echo "  â€¢ Detection: Malware, Data Exfiltration, Privilege Escalation"
echo ""
echo "ğŸ” Check results at: http://localhost:3000/incidents"
echo ""
echo "The newest incident should now show proper HIGH/CRITICAL priority! ğŸ¯"
echo ""

