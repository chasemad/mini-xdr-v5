name: Security Audit

on:
  schedule:
    - cron: '0 2 * * 0'  # Run every Sunday at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.modified, 'backend/requirements.txt') || contains(github.event.head_commit.modified, 'frontend/package.json') || contains(github.event.head_commit.modified, 'frontend/package-lock.json')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'dependency-scan'

      - name: Python Dependency Check
        if: always()
        run: |
          pip install safety
          cd backend
          safety check --json || echo "Vulnerabilities found in Python dependencies"

      - name: Node.js Dependency Audit
        if: always()
        run: |
          cd frontend
          npm audit --audit-level=moderate || echo "Vulnerabilities found in Node dependencies"

  secret-scan:
    name: Secret Detection Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --debug --only-verified

      - name: GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Scan Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/mini-xdr-backend:latest
          format: 'sarif'
          output: 'trivy-backend.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Scan Frontend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/mini-xdr-frontend:latest
          format: 'sarif'
          output: 'trivy-frontend.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Backend Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-backend.sarif'
          category: 'backend-image'

      - name: Upload Frontend Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-frontend.sarif'
          category: 'frontend-image'

  kubernetes-security:
    name: Kubernetes Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run kubesec security scanner
        uses: controlplaneio/kubesec-action@v0.0.2
        with:
          input: k8s/
          format: json
          output: kubesec-report.json

      - name: Run kube-score
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64 -O kube-score
          chmod +x kube-score
          
          echo "## Kubernetes Security Analysis" >> security-report.md
          echo "" >> security-report.md
          
          for file in $(find k8s/ -name '*.yaml' -o -name '*.yml'); do
            echo "### $file" >> security-report.md
            ./kube-score score "$file" --output-format ci >> security-report.md || true
            echo "" >> security-report.md
          done

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: kubernetes-security-report
          path: security-report.md

  sast-analysis:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:python,javascript"

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Python licenses
        run: |
          pip install pip-licenses
          cd backend
          pip install -r requirements.txt
          pip-licenses --format=markdown --output-file=../licenses-python.md || true

      - name: Check Node.js licenses
        run: |
          cd frontend
          npm install -g license-checker
          license-checker --json --out ../licenses-node.json || true

      - name: Upload license reports
        uses: actions/upload-artifact@v3
        with:
          name: license-reports
          path: |
            licenses-python.md
            licenses-node.json

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, kubernetes-security, license-compliance]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate Security Summary
        run: |
          echo "# üîí Mini-XDR Security Audit Report" > security-summary.md
          echo "" >> security-summary.md
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Scan Type | Status |" >> security-summary.md
          echo "|-----------|--------|" >> security-summary.md
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> security-summary.md
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> security-summary.md
          echo "| Kubernetes Security | ${{ needs.kubernetes-security.result }} |" >> security-summary.md
          echo "| License Compliance | ${{ needs.license-compliance.result }} |" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Recommendations" >> security-summary.md
          echo "" >> security-summary.md
          echo "- Review all CRITICAL and HIGH severity vulnerabilities" >> security-summary.md
          echo "- Update dependencies with known vulnerabilities" >> security-summary.md
          echo "- Ensure no secrets are committed to the repository" >> security-summary.md
          echo "- Validate Kubernetes security policies are enforced" >> security-summary.md
          echo "- Review license compliance for all dependencies" >> security-summary.md
          echo "" >> security-summary.md
          
          cat security-summary.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Upload Security Summary
        uses: actions/upload-artifact@v3
        with:
          name: security-summary
          path: security-summary.md

      - name: Post to GitHub Step Summary
        if: always()
        run: |
          cat security-summary.md >> $GITHUB_STEP_SUMMARY

  compliance-check:
    name: Compliance & Best Practices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security.txt
        run: |
          if [ ! -f "SECURITY.md" ]; then
            echo "‚ö†Ô∏è  Warning: SECURITY.md file not found"
            echo "Create a SECURITY.md file to document security policies"
          else
            echo "‚úÖ SECURITY.md found"
          fi

      - name: Check for proper .gitignore
        run: |
          if ! grep -q "\.env" .gitignore; then
            echo "‚ùå .gitignore doesn't exclude .env files"
            exit 1
          fi
          echo "‚úÖ .gitignore properly configured"

      - name: Check for Docker security labels
        run: |
          if ! grep -q "LABEL" backend/Dockerfile; then
            echo "‚ö†Ô∏è  Backend Dockerfile missing security labels"
          fi
          if ! grep -q "LABEL" frontend/Dockerfile; then
            echo "‚ö†Ô∏è  Frontend Dockerfile missing security labels"
          fi

      - name: Verify non-root user in containers
        run: |
          if ! grep -q "USER" backend/Dockerfile; then
            echo "‚ö†Ô∏è  Backend container may run as root"
          fi
          echo "Container security check complete"

